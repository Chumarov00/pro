<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MindAR 12</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #ar-container { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; }
    </style>
  </head>
  <body>
    <div id="ar-container">
      <a-scene 
        mindar-image="imageTargetSrc: https://chumarov00.github.io/pro/targets.mind;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: true"
        embedded
        renderer="colorManagement: true, physicallyCorrectLights">

        <a-assets>
          <a-asset-item id="model" src="https://chumarov00.github.io/pro/model2.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
          <a-gltf-model 
            id="dino"
            src="#model" 
            position="0 0 0" 
            rotation="0 0 0" 
            scale="0.3 0.3 0.3"
            <!-- ÐŸÐ ÐÐ’ÐšÐ: Ð¼Ð°Ñ…Ð°Ð½Ð¸Ðµ Ñ…Ð²Ð¾ÑÑ‚Ð¾Ð¼. ÐŸÐ¾Ð¼ÐµÐ½ÑÐ¹ node Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ! -->
            tail-wag="node: Tail; axis: y; amplitude: 0.35; speed: 1.2">
          </a-gltf-model>
        </a-entity>
      </a-scene>
    </div>

    <!-- ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚ Â«Ð¼Ð°Ñ…Ð°Ð½Ð¸Ðµ Ñ…Ð²Ð¾ÑÑ‚Ð¾Ð¼Â» -->
    <script>
      AFRAME.registerComponent('tail-wag', {
        schema: {
          node: {type: 'string', default: 'Tail'}, // Ð¸Ð¼Ñ ÐºÐ¾ÑÑ‚Ð¸/ÑƒÐ·Ð»Ð° Ñ…Ð²Ð¾ÑÑ‚Ð°
          axis: {type: 'string', default: 'y'},    // 'x' | 'y' | 'z'
          amplitude: {type: 'number', default: 0.35}, // Ñ€Ð°Ð´Ð¸Ð°Ð½Ñ‹ (~20Â°)
          speed: {type: 'number', default: 1.2},       // Ð“Ñ† (ÐºÐ¾Ð»-Ð²Ð¾ Ñ€Ð°Ð·/ÑÐµÐº)
          offset: {type: 'number', default: 0}         // Ñ„Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÑÐ´Ð²Ð¸Ð³
        },
        init() {
          this.THREE = AFRAME.THREE;
          this.target = null;
          this.baseRot = new this.THREE.Euler();
          this._bindModel = this._bindModel.bind(this);
          this.el.addEventListener('model-loaded', this._bindModel);
        },
        remove() {
          this.el.removeEventListener('model-loaded', this._bindModel);
        },
        _bindModel() {
          const obj = this.el.getObject3D('mesh');
          if (!obj) return;

          // 1) Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð½Ð°Ð¹Ñ‚Ð¸ ÑƒÐ·ÐµÐ» Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
          let t = obj.getObjectByName(this.data.node);

          // 2) ÐµÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸ â€” Ð¸Ñ‰ÐµÐ¼ ÐºÐ¾ÑÑ‚ÑŒ Ð² skeleton
          if (!t) {
            obj.traverse(o => {
              if (!t && o.isSkinnedMesh && o.skeleton) {
                const bone = o.skeleton.bones.find(b => b.name === this.data.node);
                if (bone) t = bone;
              }
            });
          }

          if (t) {
            this.target = t;
            this.baseRot.copy(t.rotation);
          } else {
            console.warn('tail-wag: Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ ÑƒÐ·ÐµÐ»/ÐºÐ¾ÑÑ‚ÑŒ Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼:', this.data.node);
          }
        },
        tick(timeMs) {
          if (!this.target) return;
          const t = timeMs / 1000;
          const a = this.data.amplitude;
          const w = this.data.speed * 2 * Math.PI; // Ñ€Ð°Ð´/Ñ
          const v = a * Math.sin(w * t + this.data.offset);

          // Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð²Ð¾ÐºÑ€ÑƒÐ³ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¹ Ð¾ÑÐ¸ Ð¾ÐºÐ¾Ð»Ð¾ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð³Ð¾ ÑƒÐ³Ð»Ð°
          const r = this.target.rotation;
          if (this.data.axis === 'x') r.x = this.baseRot.x + v;
          else if (this.data.axis === 'y') r.y = this.baseRot.y + v;
          else r.z = this.baseRot.z + v;

          this.target.updateMatrixWorld();
        }
      });

      // ðŸ”Ž Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð¼Ñ‘Ð½ ÑƒÐ·Ð»Ð¾Ð², Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ Ñ…Ð²Ð¾ÑÑ‚Ð°
      document.addEventListener('DOMContentLoaded', () => {
        const dino = document.querySelector('#dino');
        dino.addEventListener('model-loaded', (e) => {
          console.log('Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑƒÐ·Ð»Ð¾Ð²/ÐºÐ¾ÑÑ‚ÐµÐ¹ Ð¼Ð¾Ð´ÐµÐ»Ð¸:');
          e.detail.model.traverse(n => { if (n.name) console.log(n.name); });
        });
      });
    </script>
  </body>
</html>
