<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MindAR Фиксация12</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #ar-container { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; }
      #fix-button {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        font-size: 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        z-index: 2;
      }
    </style>
  </head>
  <body>
    <div id="ar-container">
      <button id="fix-button">Зафиксировать модель</button>

      <a-scene 
        mindar-image="imageTargetSrc: https://chumarov00.github.io/pro/targets.mind;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: true"
        embedded
        renderer="colorManagement: true, physicallyCorrectLights"
        id="scene">

        <a-assets>
          <a-asset-item id="model" src="https://chumarov00.github.io/pro/model.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- Обёртка модели с маркером -->
        <a-entity mindar-image-target="targetIndex: 0" id="marker-target">
          <a-gltf-model 
            id="marker-model"
            src="#model" 
            position="0 0 0" 
            rotation="0 0 0" 
            scale="0.2 0.2 0.2">
          </a-gltf-model>
        </a-entity>

        <!-- Место для зафиксированной модели -->
        <a-entity id="fixed-model-container"></a-entity>
      </a-scene>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const fixButton = document.getElementById("fix-button");
        const scene = document.querySelector("a-scene");

        fixButton.addEventListener("click", () => {
          const markerModel = document.querySelector("#marker-model");
          const markerEntity = document.querySelector("#marker-target");
          const fixedContainer = document.querySelector("#fixed-model-container");

          if (markerModel && markerEntity && fixedContainer) {
            // Получаем мировые координаты модели
            const worldPosition = new THREE.Vector3();
            const worldQuaternion = new THREE.Quaternion();
            const worldScale = new THREE.Vector3();

            markerModel.object3D.updateMatrixWorld(true);
            markerModel.object3D.matrixWorld.decompose(worldPosition, worldQuaternion, worldScale);

            // Создаём новую фиксированную модель
            const fixedModel = document.createElement("a-gltf-model");
            fixedModel.setAttribute("src", "#model");
            fixedModel.setAttribute("position", `${worldPosition.x} ${worldPosition.y} ${worldPosition.z}`);
            
            const euler = new THREE.Euler().setFromQuaternion(worldQuaternion);
            fixedModel.setAttribute("rotation", `${THREE.Math.radToDeg(euler.x)} ${THREE.Math.radToDeg(euler.y)} ${THREE.Math.radToDeg(euler.z)}`);

            fixedModel.setAttribute("scale", "0.2 0.2 0.2");

            fixedContainer.appendChild(fixedModel);

            // Удаляем модель с маркера
            markerEntity.parentNode.removeChild(markerEntity);

            // Прячем кнопку
            fixButton.style.display = "none";
          }
        });
      });
    </script>
  </body>
</html>
