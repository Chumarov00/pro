<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>MindAR </title>

  <!-- –î–ª—è —Å—Ç—Ä–∞–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ (Huawei/Tecno) -->
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; overflow:hidden; background:#000; }
    #fixBtn{
      position:fixed; top:14px; left:50%; transform:translateX(-50%);
      z-index:9999; padding:12px 20px; font-size:16px; font-weight:700;
      background:#0a7bff; color:#fff; border:0; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,.35); cursor:pointer;
    }
    #fixBtn:active{ transform:translateX(-50%) scale(.97); }
    #fixBtn.fixed{ background:#2e7d32; opacity:.9; pointer-events:none; }
    /* –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä A-Frame ‚Äì —Å—Ü–µ–Ω–∞ —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å—Ä–∞–∑—É, –º–æ–¥–µ–ª—å –≥—Ä—É–∑–∏–º –ø–æ–∑–∂–µ */
    .a-loader-title { display:none !important; }
  </style>
</head>
<body>
  <button id="fixBtn" disabled>–°–∫–∞–Ω–∏—Ä—É–π –º–∞—Ä–∫–µ—Ä‚Ä¶</button>

  <a-scene
    mindar-image="imageTargetSrc: https://chumarov00.github.io/pro/targets.mind"
    embedded color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
    id="scene">

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- –Ø–∫–æ—Ä—å –º–∞—Ä–∫–µ—Ä–∞ -->
    <a-entity id="marker" mindar-image-target="targetIndex: 0">
      <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å, —á—Ç–æ —Ç—Ä–µ–∫–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ glb -->
      <a-box id="placeholder" depth="0.2" height="0.2" width="0.2" color="#4cc3d9"></a-box>
      <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫—É–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏–º glb, –∫–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è -->
      <a-entity id="tracked" position="0 0 0" scale="0.2 0.2 0.2"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫–∞–º–µ—Ä—ã ‚Äì –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞ Huawei/Tecno
    if (navigator.mediaDevices?.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true }).catch(()=>{});
    }

    const btn       = document.getElementById('fixBtn');
    const sceneEl   = document.getElementById('scene');
    const markerEl  = document.getElementById('marker');
    const trackedEl = document.getElementById('tracked');   // —Å—é–¥–∞ –ø–æ–¥–≥—Ä—É–∑–∏–º glb
    const placeholder = document.getElementById('placeholder');
    const THREE = AFRAME.THREE;

    let modelRequested = false;
    let modelReady = false;
    let canFix = false;
    let fixed = false;

    // –ö–æ–≥–¥–∞ –º–∞—Ä–∫–µ—Ä –Ω–∞–π–¥–µ–Ω ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–Ω–æ–ø–∫—É, –∏ –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –µ—â—ë –Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
    markerEl.addEventListener('targetFound', () => {
      canFix = true;
      if (!fixed) { btn.disabled = false; btn.textContent = 'üìå –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å'; }

      if (!modelRequested) {
        modelRequested = true;
        // –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ ‚Äì –Ω–µ –¥–µ—Ä–∂–∏–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–µ–ª–æ–∞–¥–µ—Ä
        trackedEl.setAttribute('gltf-model', 'url(https://chumarov00.github.io/pro/model.glb)');
        trackedEl.addEventListener('model-loaded', () => {
          modelReady = true;
          // –£–±—Ä–∞—Ç—å –∫—É–±-–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
          if (placeholder) placeholder.parentNode.removeChild(placeholder);
        });
        trackedEl.addEventListener('model-error', (e) => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', e.detail?.src || e);
        });
      }
    });

    markerEl.addEventListener('targetLost', () => {
      canFix = false;
      if (!fixed) { btn.disabled = true; btn.textContent = '–°–∫–∞–Ω–∏—Ä—É–π –º–∞—Ä–∫–µ—Ä‚Ä¶'; }
    });

    btn.addEventListener('click', () => {
      if (fixed || !canFix) return;
      if (!modelReady) { alert('–ú–æ–¥–µ–ª—å –µ—â—ë –≥—Ä—É–∑–∏—Ç—Å—è ‚Äî –ø–æ–¥–æ–∂–¥–∏ —Å–µ–∫—É–Ω–¥—É –∏ –Ω–∞–∂–º–∏ —Å–Ω–æ–≤–∞.'); return; }

      // –û–±–Ω–æ–≤–ª—è–µ–º world-–º–∞—Ç—Ä–∏—Ü—ã
      sceneEl.object3D.updateMatrixWorld(true);

      // –ë–µ—Ä—ë–º —Ä–µ–∞–ª—å–Ω—ã–π —Ç—Ä—ë—Ö–º–µ—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç GLTF (–∞ –Ω–µ –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä a-entity)
      const mesh = trackedEl.getObject3D('mesh') || trackedEl.object3D;

      // –°—á–∏—Ç—ã–≤–∞–µ–º –º–∏—Ä–æ–≤—É—é –º–∞—Ç—Ä–∏—Ü—É –∏ —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≤ TRS
      const worldMat = mesh.matrixWorld.clone();
      const pos   = new THREE.Vector3();
      const quat  = new THREE.Quaternion();
      const scale = new THREE.Vector3();
      worldMat.decompose(pos, quat, scale);

      // –î–µ–ª–∞–µ–º –≥–ª—É–±–æ–∫–∏–π –∫–ª–æ–Ω –∏ "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º" –µ–≥–æ
      const clone = mesh.clone(true);
      clone.traverse(o => { o.matrixAutoUpdate = false; });
      clone.position.copy(pos);
      clone.quaternion.copy(quat);
      clone.scale.copy(scale);
      clone.updateMatrix();

      // –ö–ª–∞–¥—ë–º –∫–ª–æ–Ω –Ω–∞–ø—Ä—è–º—É—é –≤ –º–∏—Ä–æ–≤—É—é —Å—Ü–µ–Ω—É ‚Üí –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—Ä–∫–µ—Ä–∞/–∫–∞–º–µ—Ä—ã
      sceneEl.object3D.add(clone);

      // –ü—Ä—è—á–µ–º –º–∞—Ä–∫–µ—Ä–Ω—ã–π —è–∫–æ—Ä—å (–∫–∞–º–µ—Ä–∞/—Å–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã)
      markerEl.setAttribute('visible', false);

      // UI
      fixed = true;
      btn.classList.add('fixed');
      btn.textContent = '–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ';
      btn.disabled = true;
    });
  </script>
</body>
</html>

