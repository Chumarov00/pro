<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MindAR Fix Model</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #ar-container { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; }
      #fix-button{
        position:absolute; top:20px; left:50%; transform:translateX(-50%);
        padding:12px 24px; font-size:18px; font-weight:bold;
        background:rgba(0,123,255,0.9); color:#fff; border:none; border-radius:10px;
        z-index:10; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.2);
      }
      #fix-button.fixed{ background:green; pointer-events:none; opacity:.85; }
    </style>
  </head>
  <body>
    <div id="ar-container">
      <button id="fix-button" disabled>–°–∫–∞–Ω–∏—Ä—É–π –º–∞—Ä–∫–µ—Ä‚Ä¶</button>

      <a-scene 
        mindar-image="imageTargetSrc: https://chumarov00.github.io/pro/targets.mind;" 
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: true"
        embedded
        renderer="colorManagement: true, physicallyCorrectLights"
        id="scene">

        <a-assets>
          <a-asset-item id="model" src="https://chumarov00.github.io/pro/model.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- –ú–∞—Ä–∫–µ—Ä + –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–∞—è –º–æ–¥–µ–ª—å -->
        <a-entity id="model-container" mindar-image-target="targetIndex: 0">
          <a-gltf-model id="tracked-model" src="#model" position="0 0 0" scale="0.2 0.2 0.2"></a-gltf-model>
        </a-entity>
      </a-scene>
    </div>

    <script>
      const THREE = AFRAME.THREE;                       // ‚úÖ –∫–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
      const btn            = document.getElementById('fix-button');
      const sceneEl        = document.getElementById('scene');
      const markerEntity   = document.getElementById('model-container');
      const trackedEntity  = document.getElementById('tracked-model');

      let fixed = false;
      let markerVisible = false;

      // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –º–∞—Ä–∫–µ—Ä –≤ –∫–∞–¥—Ä–µ
      markerEntity.addEventListener('targetFound', () => { markerVisible = true; if(!fixed){ btn.disabled = false; btn.textContent='üìå –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å'; }});
      markerEntity.addEventListener('targetLost',  () => { markerVisible = false; if(!fixed){ btn.disabled = true;  btn.textContent='–°–∫–∞–Ω–∏—Ä—É–π –º–∞—Ä–∫–µ—Ä‚Ä¶'; }});

      btn.addEventListener('click', () => {
        if (fixed || !markerVisible) return;

        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ world-–º–∞—Ç—Ä–∏—Ü—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã
        sceneEl.object3D.updateMatrixWorld(true);

        const src = trackedEntity.object3D;
        const pos   = new THREE.Vector3();
        const quat  = new THREE.Quaternion();
        const scale = new THREE.Vector3();
        src.getWorldPosition(pos);
        src.getWorldQuaternion(quat);
        src.getWorldScale(scale);

        // –°–æ–∑–¥–∞—ë–º –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é —Å—É—â–Ω–æ—Å—Ç—å
        const fixedEntity = document.createElement('a-entity');
        fixedEntity.setAttribute('gltf-model', '#model');
        fixedEntity.setAttribute('scale', `${scale.x} ${scale.y} ${scale.z}`);

        // –ñ–¥—ë–º, –ø–æ–∫–∞ GLTF –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–Ω–æ—Å–∏–º –ú–ò–†–û–í–´–ï TRS –∏ "–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º" –º–∞—Ç—Ä–∏—Ü—É
        fixedEntity.addEventListener('model-loaded', () => {
          const obj = fixedEntity.getObject3D('mesh') || fixedEntity.object3D;
          obj.position.copy(pos);
          obj.quaternion.copy(quat);
          obj.updateMatrix();
          obj.matrixAutoUpdate = false;               // üîí –±–æ–ª—å—à–µ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è/–Ω–µ –¥—Ä–æ–∂–∏—Ç
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –°–¶–ï–ù–£ (–Ω–µ –≤ –º–∞—Ä–∫–µ—Ä, –Ω–µ –≤ –∫–∞–º–µ—Ä—É)
        sceneEl.appendChild(fixedEntity);

        // –ü—Ä—è—á–µ–º –º–∞—Ä–∫–µ—Ä–Ω—É—é –≤–µ—Ä—Å–∏—é, —Å–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º
        markerEntity.setAttribute('visible', 'false');

        fixed = true;
        btn.classList.add('fixed');
        btn.textContent = '–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ';
        btn.disabled = true;
      });
    </script>
  </body>
</html>
